<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperborea Character Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-900 text-orange-500 min-h-screen">
<div class="container mx-auto px-4 py-8" x-data="attributeGenerator">
    <h1 class="text-3xl font-bold text-center mb-8 text-orange-500">Hyperborea Character Generator</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Section 1: Attribute Generation Methods -->
        <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-orange-500 h-[800px] flex flex-col">
            <h2 class="text-xl font-semibold mb-4 text-orange-400">Generation Methods</h2>
            <div class="grid grid-cols-1 gap-3 flex-grow">
                <template x-for="(method, index) in methods" :key="index">
                    <button type="button"
                            class="p-4 rounded-md border text-left transition-colors duration-200 hover:bg-gray-700"
                            :class="selectedMethod === method.id ? 'bg-gray-700 border-orange-500 text-orange-400' : 'bg-gray-800 border-gray-700 text-orange-300'"
                            @click="selectedMethod = method.id">
                        <div class="font-bold" x-text="method.name"></div>
                        <div class="text-sm opacity-80 mt-1" x-text="method.description"></div>
                    </button>
                </template>
            </div>

            <div class="mt-6">
                <button @click="generateAttributes()"
                        class="w-full py-2 bg-orange-600 text-white font-medium rounded hover:bg-orange-700">
                    Generate Attributes
                </button>
            </div>
        </div>

        <!-- Section 2: Generated Attributes -->
        <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-orange-500 h-[800px] flex flex-col">
            <h2 class="text-xl font-semibold mb-2 text-orange-400 text-center" x-show="selectedMethod !== 'methodVI' || !methodVIClassSelection">Generated Attributes</h2>
            <div class="flex-grow flex flex-col justify-center">

            <!-- Method VI Class Selection (only shown during selection phase) -->
            <template x-if="selectedMethod === 'methodVI' && methodVIClassSelection">
                <div class="flex-grow flex flex-col justify-start">
                    <h2 class="text-xl font-semibold mb-4 text-orange-400 text-center">Class Selection</h2>
                    
                    <div class="space-y-4 overflow-y-auto max-h-[600px] flex-grow pr-2">
                        <template x-for="(cls, index) in classes" :key="index">
                            <div 
                                class="p-3 rounded-md border cursor-pointer"
                                :class="selectedClassForMethodVI === cls ? 'bg-gray-700 border-orange-500 text-orange-400' : 'bg-gray-700 border-gray-600 text-orange-300 hover:border-orange-400'"
                                @click="selectedClassForMethodVI = cls">
                                <div class="flex items-center">
                                    <span x-text="cls.name" class="font-medium"></span>
                                </div>
                                <div class="text-sm text-orange-300 mt-1">
                                    <span x-text="formatRequirements(cls.requirements)"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button 
                            @click="generateMethodVIAttributes()"
                            class="px-6 py-2 bg-orange-600 text-white font-medium rounded hover:bg-orange-700"
                            :disabled="!selectedClassForMethodVI">
                            Generate Attributes for <span x-text="selectedClassForMethodVI ? selectedClassForMethodVI.name : ''"></span>
                        </button>
                    </div>
                </div>
            </template>

            <!-- Generated attributes for Method VI (shown after class selection) -->
            <template x-if="selectedMethod === 'methodVI' && !methodVIClassSelection && attributes">
                <div class="flex-grow flex flex-col justify-center">
                    <div class="space-y-5 flex flex-col items-center">
                        <template x-for="(attr, index) in attributeNames" :key="index">
                            <div class="relative mb-4">
                                <div class="absolute -left-9 top-1/2 transform -translate-y-1/2 font-bold text-orange-500 text-right w-8"
                                     x-text="attr.substring(0, 3).toUpperCase()"></div>
                                <div class="h-20 w-20 bg-gray-700 border border-orange-700 rounded-md flex items-center justify-center">
                                    <div class="text-center">
                                        <div x-text="attributes[attr.toLowerCase()]" class="text-xl font-bold"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Standard attribute display - only show when not in Method II or Method VI -->
            <template x-if="(selectedMethod !== 'methodII' || !methodIISets) && selectedMethod !== 'methodVI'">
                <div class="flex flex-col items-center flex-grow justify-center">
                    <template x-if="attributes && generatedValues && selectedMethod === 'methodIII'">
                        <h3 class="text-sm font-medium mb-4 text-orange-300 text-center">Use the dropdowns to assign values to attributes</h3>
                    </template>

                    <div class="space-y-5 flex flex-col items-center">
                        <template x-for="(attr, index) in attributeNames" :key="index">
                            <div class="relative mb-4">
                                <div class="absolute -left-9 top-1/2 transform -translate-y-1/2 font-bold text-orange-500 text-right w-8"
                                     x-text="attr.substring(0, 3).toUpperCase()"></div>
                                <div class="h-20 w-20 bg-gray-700 border border-orange-700 rounded-md flex items-center justify-center">
                                    <template x-if="attributes">
                                        <div class="text-center">
                                            <div x-text="attributes[attr.toLowerCase()]" class="text-xl font-bold"></div>
                                        </div>
                                    </template>
                                    <template x-if="!attributes">
                                        <div class="text-orange-300 opacity-70">-</div>
                                    </template>
                                </div>
                                <!-- Value selector - only for Method III -->
                                <template x-if="attributes && generatedValues && selectedMethod === 'methodIII'">
                                    <div class="absolute -right-16 top-1/2 transform -translate-y-1/2">
                                        <select class="bg-gray-800 text-orange-400 border border-orange-700 rounded py-1 px-2"
                                                @change="(e) => assignAttributeValue(attr, parseInt(e.target.value))">
                                            <template x-for="(value, valueIndex) in generatedValues" :key="valueIndex">
                                                <option :value="valueIndex" :selected="attributes[attr.toLowerCase()] === value"
                                                        x-text="value"></option>
                                            </template>
                                        </select>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>

                    <template x-if="attributes">
                        <div class="mt-4 pt-4 border-t border-orange-700 w-full">
                            <!-- Total and average removed as requested -->
                        </div>
                    </template>
                </div>
            </template>

            <!-- Method II Sets Selection (3 columns with box display) -->
            <template x-if="selectedMethod === 'methodII' && methodIISets">
                <div class="flex-grow flex flex-col justify-center">
                    <h3 class="text-sm font-medium mb-4 text-orange-300 text-center">
                        <span x-text="selectedSetIndex === -1 ? 'Select one of the three attribute sets:' : 'Click on a set to view its details:'"></span>
                    </h3>

                    <div class="grid grid-cols-3 gap-2 w-full px-1">
                        <!-- Set 1 -->
                        <div class="flex flex-col items-center space-y-1 p-1 rounded-md cursor-pointer"
                             :class="[
                                highlightedSet === 0 ? 'bg-gray-700' : '',
                                selectedSetIndex === 0 ? 'border-2 border-orange-500 bg-gray-700' : ''
                             ]"
                             @mouseenter="highlightedSet = 0"
                             @mouseleave="highlightedSet = selectedSetIndex === 0 ? 0 : -1"
                             @click="previewMethodIISet(0)">
                            <div class="text-center mb-1">
                                <span class="font-medium text-orange-400">Set 1</span>
                                <template x-if="selectedSetIndex === 0">
                                    <span class="ml-1 text-orange-500 text-xs">(Selected)</span>
                                </template>
                            </div>

                            <!-- Set 1 Attributes -->
                            <template x-for="(attr, attrIndex) in attributeNames" :key="attrIndex">
                                <div class="relative flex items-center mb-1">
                                    <div class="mr-1 font-bold text-orange-500 text-right w-8"
                                         x-text="attr.substring(0, 3).toUpperCase()"></div>
                                    <div class="h-16 w-16 bg-gray-700 border border-orange-700 rounded-md flex items-center justify-center">
                                        <div class="text-center">
                                            <div x-text="methodIISets[0][attrIndex]" class="font-bold"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <div class="text-center mt-2 pt-2 border-t border-gray-600 w-full">
                                <!-- Total removed as requested -->
                            </div>
                            <!-- Removed qualified classes section as requested -->
                        </div>

                        <!-- Set 2 -->
                        <div class="flex flex-col items-center space-y-1 p-1 rounded-md cursor-pointer"
                             :class="[
                                highlightedSet === 1 ? 'bg-gray-700' : '',
                                selectedSetIndex === 1 ? 'border-2 border-orange-500 bg-gray-700' : ''
                             ]"
                             @mouseenter="highlightedSet = 1"
                             @mouseleave="highlightedSet = selectedSetIndex === 1 ? 1 : -1"
                             @click="previewMethodIISet(1)">
                            <div class="text-center mb-1">
                                <span class="font-medium text-orange-400">Set 2</span>
                                <template x-if="selectedSetIndex === 1">
                                    <span class="ml-1 text-orange-500 text-xs">(Selected)</span>
                                </template>
                            </div>

                            <!-- Set 2 Attributes -->
                            <template x-for="(attr, attrIndex) in attributeNames" :key="attrIndex">
                                <div class="relative flex items-center mb-1">
                                    <div class="mr-1 font-bold text-orange-500 text-right w-8"
                                         x-text="attr.substring(0, 3).toUpperCase()"></div>
                                    <div class="h-16 w-16 bg-gray-700 border border-orange-700 rounded-md flex items-center justify-center">
                                        <div class="text-center">
                                            <div x-text="methodIISets[1][attrIndex]" class="font-bold"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <div class="text-center mt-2 pt-2 border-t border-gray-600 w-full">
                                <!-- Total removed as requested -->
                            </div>
                            <!-- Removed qualified classes section as requested -->
                        </div>

                        <!-- Set 3 -->
                        <div class="flex flex-col items-center space-y-1 p-1 rounded-md cursor-pointer"
                             :class="[
                                highlightedSet === 2 ? 'bg-gray-700' : '',
                                selectedSetIndex === 2 ? 'border-2 border-orange-500 bg-gray-700' : ''
                             ]"
                             @mouseenter="highlightedSet = 2"
                             @mouseleave="highlightedSet = selectedSetIndex === 2 ? 2 : -1"
                             @click="previewMethodIISet(2)">
                            <div class="text-center mb-1">
                                <span class="font-medium text-orange-400">Set 3</span>
                                <template x-if="selectedSetIndex === 2">
                                    <span class="ml-1 text-orange-500 text-xs">(Selected)</span>
                                </template>
                            </div>

                            <!-- Set 3 Attributes -->
                            <template x-for="(attr, attrIndex) in attributeNames" :key="attrIndex">
                                <div class="relative flex items-center mb-1">
                                    <div class="mr-1 font-bold text-orange-500 text-right w-8"
                                         x-text="attr.substring(0, 3).toUpperCase()"></div>
                                    <div class="h-16 w-16 bg-gray-700 border border-orange-700 rounded-md flex items-center justify-center">
                                        <div class="text-center">
                                            <div x-text="methodIISets[2][attrIndex]" class="font-bold"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <div class="text-center mt-2 pt-2 border-t border-gray-600 w-full">
                                <!-- Total removed as requested -->
                            </div>
                            <!-- Removed qualified classes section as requested -->
                        </div>
                    </div>

                    <!-- Choose button for the selected set -->
                    <div class="mt-4 text-center">
                        <template x-if="selectedSetIndex !== -1">
                            <button @click="selectMethodIISet(selectedSetIndex)"
                                    class="px-6 py-2 bg-orange-600 text-white font-medium rounded hover:bg-orange-700">
                                Choose Set <span x-text="selectedSetIndex + 1"></span>
                            </button>
                        </template>
                        <template x-if="selectedSetIndex === -1">
                            <div class="text-orange-300 text-sm">
                                Click a set to preview and select it
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            </div>
            <template x-if="!attributes && selectedMethod !== 'methodII'">
                <div class="text-center py-8 text-orange-400 opacity-70">
                    Select a generation method and click "Generate Attributes" to begin
                </div>
            </template>
        </div>

        <!-- Section 3: Class Qualifications (hidden for Method VI) -->
        <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-orange-500 h-[800px] flex flex-col" x-show="selectedMethod !== 'methodVI'">
            <h2 class="text-xl font-semibold mb-4 text-orange-400">Class Qualifications</h2>
            <template x-if="attributes">
                <div class="space-y-4 overflow-y-auto flex-grow pr-2">
                    <template x-for="(cls, index) in getSortedQualifyingClasses()" :key="index">
                        <div class="p-3 rounded-md bg-gray-700 border border-orange-500">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <span class="w-8 h-8 rounded-full bg-orange-600 flex items-center justify-center mr-3 text-white font-bold" x-text="cls.rank"></span>
                                    <span x-text="cls.name" class="font-medium"></span>
                                </div>
                            </div>
                            <div class="text-sm text-orange-300 mt-1">
                                <span x-text="formatRequirements(cls.requirements)"></span>
                            </div>
                        </div>
                    </template>

                    <template x-if="getSortedQualifyingClasses().length === 0">
                        <div class="text-center py-4 text-orange-400">
                            Character does not qualify for any classes
                        </div>
                    </template>
                </div>
            </template>
            <template x-if="!attributes">
                <div class="text-center py-8 text-orange-400 opacity-70 flex-grow flex items-center justify-center">
                    Generate attributes to see class qualifications
                </div>
            </template>
        </div>
        
        <!-- Selected Class info for Method VI -->
        <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-orange-500 h-[800px] flex flex-col" x-show="selectedMethod === 'methodVI'">
            <h2 class="text-xl font-semibold mb-4 text-orange-400">Selected Class</h2>
            
            <template x-if="selectedClassForMethodVI">
                <div class="flex-grow flex flex-col justify-center items-center">
                    <div class="p-6 rounded-md bg-gray-700 border border-orange-500 max-w-[80%] text-center">
                        <div class="text-2xl font-medium text-orange-400 mb-4" x-text="selectedClassForMethodVI.name"></div>
                        <div class="text-lg text-orange-300 mb-6" x-text="formatRequirements(selectedClassForMethodVI.requirements)"></div>
                        
                        <div class="mt-6 pt-6 border-t border-orange-600">
                            <div class="text-lg text-orange-300 mb-2">Prime Attributes:</div>
                            <div class="flex flex-wrap justify-center gap-3">
                                <template x-for="(primeAttr, index) in selectedClassForMethodVI.primeAttributes" :key="index">
                                    <div class="px-3 py-1 bg-gray-600 rounded-md text-orange-400 font-medium" 
                                         x-text="primeAttr.charAt(0) + primeAttr.slice(1).toLowerCase()"></div>
                                </template>
                            </div>
                        </div>
                        
                        <div class="mt-8 text-sm text-orange-300" x-show="!methodVIClassSelection && attributes">
                            <span>Attributes have been optimized for this class</span>
                        </div>
                    </div>
                </div>
            </template>
            
            <template x-if="!selectedClassForMethodVI">
                <div class="flex-grow flex items-center justify-center">
                    <div class="text-center text-orange-300">
                        Select a class to optimize your character's attributes
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('attributeGenerator', () => ({
            // State
            selectedMethod: 'methodIII',
            attributes: null,
            attributeNames: ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'],
            generatedValues: null,
            methodIISets: null,
            selectedSetIndex: -1,
            highlightedSet: -1,
            attributeAssignments: {},
            methodVIClassSelection: false,
            selectedClassForMethodVI: null,

            // Methods
            methods: [
                {
                    id: 'methodI',
                    name: 'Method I: 3d6 in order',
                    description: 'Roll 3d6 for each attribute in order'
                },
                {
                    id: 'methodII',
                    name: 'Method II: 3 sets, choose best',
                    description: 'Roll 3 complete sets of 3d6 and select your preferred set'
                },
                {
                    id: 'methodIII',
                    name: 'Method III: 4d6 drop lowest',
                    description: 'Roll 4d6, discard lowest die for each attribute'
                },
                {
                    id: 'methodIV',
                    name: 'Method IV: Best of 3 Ã— 3d6',
                    description: 'Roll 3d6 three times for each attribute, take best roll'
                },
                {
                    id: 'methodV',
                    name: 'Method V: 2d6+6',
                    description: 'Roll 2d6+6 for each attribute (higher average)'
                },
                {
                    id: 'methodVI',
                    name: 'Method VI: Class-specific',
                    description: 'Roll 4d6 (discard low) for required attributes, 3d6 for others'
                }
            ],

            // Classes
            classes: [
                {
                    name: 'Fighter',
                    requirements: { 'Strength': 9 },
                    primeAttributes: ['STRENGTH']
                },
                {
                    name: 'Magician',
                    requirements: { 'Intelligence': 9 },
                    primeAttributes: ['INTELLIGENCE']
                },
                {
                    name: 'Cleric',
                    requirements: { 'Wisdom': 9 },
                    primeAttributes: ['WISDOM']
                },
                {
                    name: 'Thief',
                    requirements: { 'Dexterity': 9 },
                    primeAttributes: ['DEXTERITY']
                },
                {
                    name: 'Barbarian',
                    requirements: {
                        'Strength': 13,
                        'Dexterity': 13,
                        'Constitution': 13,
                    },
                    primeAttributes: ['STRENGTH', 'DEXTERITY']
                },
                {
                    name: 'Berserker',
                    requirements: {
                        'Strength': 15,
                        'Constitution': 15
                    },
                    primeAttributes:  ['STRENGTH', 'CONSTITUTION']
                },
                {
                    name: 'Cataphract',
                    requirements: {
                        'Strength': 9,
                        'Dexterity': 9,
                        'Wisdom': 9,
                        'Charisma': 9,
                    },
                    primeAttributes: ['STRENGTH', 'CHARISMA']
                },
                {
                    name: 'Huntsman',
                    requirements: {
                        'Strength': 9,
                        'Dexterity': 9,
                        'Wisdom': 9,
                        'Charisma': 12,
                    },
                    primeAttributes:  ['STRENGTH', 'WISDOM']
                },
                {
                    name: 'Paladin',
                    requirements: {
                        'Strength': 9,
                        'Dexterity': 9,
                        'Wisdom': 9,
                        'Charisma': 15,
                    },
                    primeAttributes:  ['STRENGTH', 'CHARISMA']
                },
                {
                    name: 'Ranger',
                    requirements: {
                        'Strength': 9,
                        'Dexterity': 9,
                        'Intelligence': 9,
                        'Wisdom': 9
                    },
                    primeAttributes: ['STRENGTH', 'WISDOM']
                },
                {
                    name: 'Warlock',
                    requirements: {
                        'Strength': 12,
                        'Intelligence': 12
                    },
                    primeAttributes:   ['STRENGTH', 'INTELLIGENCE']
                },
                {
                    name: 'Warlock (Death Soldier)',
                    requirements: {
                        'Strength': 12,
                        'Intelligence': 12,
                        'Wisdom': 12
                    },
                    primeAttributes:  ['STRENGTH', 'INTELLIGENCE']
                },
                {
                    name: 'Warlock (Fire Lord)',
                    requirements: {
                        'Strength': 12,
                        'Intelligence': 12,
                        'Wisdom': 12
                    },
                    primeAttributes:  ['STRENGTH', 'INTELLIGENCE']
                },
                {
                    name: 'Warlock (Ice Lord)',
                    requirements: {
                        'Strength': 12,
                        'Intelligence': 12,
                        'Wisdom': 12
                    },
                    primeAttributes:   ['STRENGTH', 'INTELLIGENCE']
                },
                {
                    name: 'Cryomancer',
                    requirements: {
                        'Intelligence': 9,
                        'Wisdom': 9
                    },
                    primeAttributes:   ['INTELLIGENCE', 'WISDOM']
                },
                {
                    name: 'Illusionist',
                    requirements: {
                        'Dexterity': 9,
                        'Intelligence': 9
                    },
                    primeAttributes: ['DEXTERITY', 'INTELLIGENCE']
                },
                {
                    name: 'Necromancer',
                    requirements: {
                        'Intelligence': 9,
                        'Wisdom': 9
                    },
                    primeAttributes:   ['INTELLIGENCE', 'WISDOM']
                },
                {
                    name: 'Pyromancer',
                    requirements: {
                        'Intelligence': 9,
                        'Wisdom': 9
                    },
                    primeAttributes:   ['INTELLIGENCE', 'WISDOM']
                },
                {
                    name: 'Witch',
                    requirements: {
                        'Intelligence': 9,
                        'Wisdom': 9,
                        'Charisma': 12,
                    },
                    primeAttributes:  ['INTELLIGENCE', 'CHARISMA']
                },
                {
                    name: 'Druid',
                    requirements: {
                        'Wisdom': 9,
                        'Charisma': 12,
                    },
                    primeAttributes: ['WISDOM', 'CHARISMA']
                },
                {
                    name: 'Monk',
                    requirements: {
                        'Strength': 9,
                        'Dexterity': 9,
                        'Wisdom': 9
                    },
                    primeAttributes: ['DEXTERITY', 'WISDOM']
                },
                {
                    name: 'Priest',
                    requirements: {
                      'Wisdom': 9,
                      'Charisma': 9
                    },
                    primeAttributes:   ['WISDOM', 'CHARISMA']
                },
                {
                    name: 'Runegraver',
                    requirements: {
                        'Strength': 9,
                        'Wisdom': 12
                    },
                    primeAttributes: ['STRENGTH', 'WISDOM']
                },
                {
                    name: 'Shaman',
                    requirements: {
                        'Intelligence': 9,
                        'Wisdom': 12,
                    },
                    primeAttributes:   ['INTELLIGENCE', 'WISDOM']
                },
                {
                    name: 'Assassin',
                    requirements: {
                        'Strength': 9,
                        'Dexterity': 9,
                        'Intelligence': 9
                    },
                    primeAttributes:   ['DEXTERITY', 'INTELLIGENCE']
                },
                {
                    name: 'Bard',
                    requirements: {
                        'Strength': 9,
                        'Dexterity': 9,
                        'Intelligence': 9,
                        'Wisdom': 9,
                        'Charisma': 15
                    },
                    primeAttributes:  ['DEXTERITY', 'CHARISMA']
                },
                {
                    name: 'Legerdemainist',
                    requirements: {
                        'Dexterity': 12,
                        'Intelligence': 12
                    },
                    primeAttributes: ['DEXTERITY', 'INTELLIGENCE']
                },
                {
                    name: 'Legerdemainist (Fire Thief)',
                    requirements: {
                        'Dexterity': 12,
                        'Intelligence': 12,
                        'Wisdom': 12
                    },
                    primeAttributes: ['DEXTERITY', 'INTELLIGENCE']
                },
                {
                    name: 'Legerdemainist (Ice Thief)',
                    requirements: {
                        'Dexterity': 12,
                        'Intelligence': 12,
                        'Wisdom': 12
                    },
                    primeAttributes: ['DEXTERITY', 'INTELLIGENCE']
                },
                {
                    name: 'Purloiner',
                    requirements: {
                        'Dexterity': 12,
                        'Wisdom': 12
                    },
                    primeAttributes: ['DEXTERITY', 'WISDOM']
                },
                {
                    name: 'Scout',
                    requirements: {
                        'Dexterity': 9,
                        'Intelligence': 9
                    },
                    primeAttributes:   ['DEXTERITY', 'INTELLIGENCE']
                }
            ],

            // Methods implementation
            init() {
                console.log('Attribute Generator initialized');
            },

            calculateTotal(values) {
                return values.reduce((sum, val) => sum + val, 0);
            },

            rollDie(sides) {
                return Math.floor(Math.random() * sides) + 1;
            },

            rollThreeD6() {
                return this.rollDie(6) + this.rollDie(6) + this.rollDie(6);
            },

            rollFourD6DropLowest() {
                const rolls = [this.rollDie(6), this.rollDie(6), this.rollDie(6), this.rollDie(6)];
                const minRoll = Math.min(...rolls);
                const minIndex = rolls.indexOf(minRoll);
                rolls.splice(minIndex, 1);
                return rolls.reduce((sum, value) => sum + value, 0);
            },

            roll2D6Plus6() {
                return this.rollDie(6) + this.rollDie(6) + 6;
            },

            generateAttributes() {
                console.log('Generating attributes using method:', this.selectedMethod);
                
                // Reset method-specific states
                this.methodIISets = null;
                this.selectedSetIndex = -1;
                
                // For Method VI, show class selection
                if (this.selectedMethod === 'methodVI') {
                    this.methodVIClassSelection = true;
                    this.selectedClassForMethodVI = null;
                    this.attributes = null;
                    return;
                }
                
                this.methodVIClassSelection = false;
                
                let values = [];

                switch (this.selectedMethod) {
                    case 'methodI':
                        // METHOD I: Roll 3d6 for each attribute in order
                        values = [
                            this.rollThreeD6(), // STR
                            this.rollThreeD6(), // DEX
                            this.rollThreeD6(), // CON
                            this.rollThreeD6(), // INT
                            this.rollThreeD6(), // WIS
                            this.rollThreeD6()  // CHA
                        ];
                        this.applyAttributeValues(values);
                        break;

                    case 'methodII':
                        // METHOD II: Roll 3d6 for each attribute in order, 3 sets, choose best
                        this.methodIISets = [
                            [
                                this.rollThreeD6(), this.rollThreeD6(), this.rollThreeD6(),
                                this.rollThreeD6(), this.rollThreeD6(), this.rollThreeD6()
                            ],
                            [
                                this.rollThreeD6(), this.rollThreeD6(), this.rollThreeD6(),
                                this.rollThreeD6(), this.rollThreeD6(), this.rollThreeD6()
                            ],
                            [
                                this.rollThreeD6(), this.rollThreeD6(), this.rollThreeD6(),
                                this.rollThreeD6(), this.rollThreeD6(), this.rollThreeD6()
                            ]
                        ];
                        this.selectedSetIndex = -1; // Reset selection
                        this.attributes = null;     // Clear attributes until a set is selected
                        break;

                    case 'methodIII':
                        // METHOD III: 4d6 drop lowest, assign as desired
                        values = Array(6).fill(0).map(() => this.rollFourD6DropLowest());
                        values.sort((a, b) => b - a); // Sort descending
                        this.applyAttributeValues(values);
                        break;

                    case 'methodIV':
                        // METHOD IV: Roll 3d6 three times for each attribute, select best result
                        values = [];

                        // For each attribute, roll 3d6 three times and take the highest value
                        for (let i = 0; i < 6; i++) {
                            const roll1 = this.rollThreeD6();
                            const roll2 = this.rollThreeD6();
                            const roll3 = this.rollThreeD6();
                            values.push(Math.max(roll1, roll2, roll3));
                        }

                        this.applyAttributeValues(values);
                        break;

                    case 'methodV':
                        // METHOD V: Roll 2d6+6 for each attribute in order
                        values = [];
                        for (let i = 0; i < 6; i++) {
                            values.push(this.roll2D6Plus6());
                        }
                        this.applyAttributeValues(values);
                        break;

                    case 'methodVI':
                        // METHOD VI: Class-specific method with requirements (using Fighter as default)
                        const selectedClass = this.classes[0]; // Default to Fighter
                        values = [];

                        // Get required attributes for the selected class
                        const requiredAttrs = Object.keys(selectedClass.requirements);

                        for (let i = 0; i < this.attributeNames.length; i++) {
                            const attrName = this.attributeNames[i];

                            if (requiredAttrs.includes(attrName)) {
                                // This attribute has a requirement, roll 4d6 drop lowest until we meet it
                                let minRequired = selectedClass.requirements[attrName];
                                let roll = this.rollFourD6DropLowest();

                                // Keep rolling until we meet the requirement
                                while (roll < minRequired) {
                                    roll = this.rollFourD6DropLowest();
                                }

                                values.push(roll);
                            } else {
                                // No requirement, just roll 3d6
                                values.push(this.rollThreeD6());
                            }
                        }
                        this.applyAttributeValues(values);
                        break;
                }
            },

            applyAttributeValues(values) {
                // Store the original generated values
                this.generatedValues = [...values];

                // Create the attributes object
                this.attributes = {
                    strength: values[0],
                    dexterity: values[1],
                    constitution: values[2],
                    intelligence: values[3],
                    wisdom: values[4],
                    charisma: values[5]
                };

                // Initialize attribute assignments
                this.attributeAssignments = {};
                this.attributeNames.forEach((attr, index) => {
                    this.attributeAssignments[values[index]] = attr;
                });
            },

            // Preview a set without selecting it yet
            previewMethodIISet(setIndex) {
                if (!this.methodIISets || setIndex < 0 || setIndex > 2) return;

                // Toggle preview selection if clicking on the currently previewed set
                if (this.selectedSetIndex === setIndex) {
                    this.selectedSetIndex = -1;
                    return;
                }

                this.selectedSetIndex = setIndex;

                // Set current attributes for display but don't commit to them yet
                const values = this.methodIISets[setIndex];

                // Create temporary attributes for qualification checks
                let tempAttributes = {
                    strength: values[0],
                    dexterity: values[1],
                    constitution: values[2],
                    intelligence: values[3],
                    wisdom: values[4],
                    charisma: values[5]
                };

                // Set as temporary attributes for display but don't fully apply
                this.attributes = tempAttributes;
            },

            // Commit to using the selected set
            selectMethodIISet(setIndex) {
                if (!this.methodIISets || setIndex < 0 || setIndex > 2) return;

                this.selectedSetIndex = setIndex;
                const values = this.methodIISets[setIndex];

                this.applyAttributeValues(values);
            },

            // Get qualified classes for a given attribute set
            getQualifiedClassesForSet(setIndex) {
                if (!this.methodIISets || setIndex < 0 || setIndex > 2) return [];

                const values = this.methodIISets[setIndex];
                const tempAttributes = {
                    strength: values[0],
                    dexterity: values[1],
                    constitution: values[2],
                    intelligence: values[3],
                    wisdom: values[4],
                    charisma: values[5]
                };

                return this.classes
                    .filter(characterClass => {
                        for (const [attrName, minValue] of Object.entries(characterClass.requirements)) {
                            if (tempAttributes[attrName.toLowerCase()] < minValue) {
                                return false;
                            }
                        }
                        return true;
                    })
                    .map(characterClass => characterClass.name);
            },

            assignAttributeValue(attrName, valueIndex) {
                if (!this.generatedValues) return;

                const newValue = this.generatedValues[valueIndex];

                // Find current value assigned to the target attribute
                let currentAttrValue = null;
                let currentValueIndex = -1;

                // Find the current attribute's value and its index in generatedValues
                for (let i = 0; i < this.attributeNames.length; i++) {
                    if (this.attributeNames[i].toLowerCase() === attrName.toLowerCase()) {
                        currentAttrValue = this.attributes[attrName.toLowerCase()];
                        // Find index of this value in generatedValues
                        currentValueIndex = this.generatedValues.indexOf(currentAttrValue);
                        break;
                    }
                }

                if (currentValueIndex !== -1) {
                    // Find which attribute is currently assigned to the new value
                    let otherAttrName = null;
                    for (let i = 0; i < this.attributeNames.length; i++) {
                        const attr = this.attributeNames[i].toLowerCase();
                        if (this.attributes[attr] === newValue) {
                            otherAttrName = attr;
                            break;
                        }
                    }

                    if (otherAttrName) {
                        // Swap the values
                        const tempAttr = { ...this.attributes };
                        tempAttr[attrName.toLowerCase()] = newValue;
                        tempAttr[otherAttrName] = currentAttrValue;
                        this.attributes = tempAttr;
                    }
                }
            },

            getAttributeValue(attrName) {
                if (!this.attributes) return 0;
                return this.attributes[attrName.toLowerCase()] || 0;
            },

            getModifier(attrName) {
                const value = this.getAttributeValue(attrName);
                return Math.floor((value - 10) / 2);
            },

            formatModifier(mod) {
                return mod >= 0 ? `+${mod}` : `${mod}`;
            },

            getModifierClass(mod) {
                if (mod > 0) return 'text-orange-500';
                if (mod < 0) return 'text-gray-400';
                return 'text-orange-300';
            },

            getAttributeTotal() {
                if (!this.attributes) return 0;
                return Object.values(this.attributes).reduce((sum, value) => sum + value, 0);
            },

            getAttributeAverage() {
                if (!this.attributes) return "0";
                const total = this.getAttributeTotal();
                return (total / 6).toFixed(1);
            },

            qualifiesForClass(characterClass) {
                if (!this.attributes) return false;

                for (const [attrName, minValue] of Object.entries(characterClass.requirements)) {
                    if (this.getAttributeValue(attrName) < minValue) {
                        return false;
                    }
                }

                return true;
            },

            formatRequirements(requirements) {
                return Object.entries(requirements)
                    .map(([attr, value]) => `${attr}: ${value}+`)
                    .join(', ');
            },
            
            generateMethodVIAttributes() {
                if (!this.selectedClassForMethodVI) return;
                
                const selectedClass = this.selectedClassForMethodVI;
                let values = [];
                
                // Get required attributes for the selected class
                const requiredAttrs = Object.keys(selectedClass.requirements);
                
                for (let i = 0; i < this.attributeNames.length; i++) {
                    const attrName = this.attributeNames[i];
                    
                    if (requiredAttrs.includes(attrName)) {
                        // For required attributes use Method III (4d6 drop lowest)
                        // and keep rolling until the requirement is met
                        let minRequired = selectedClass.requirements[attrName];
                        let roll = this.rollFourD6DropLowest();
                        
                        // Keep rolling until we meet the requirement
                        while (roll < minRequired) {
                            roll = this.rollFourD6DropLowest();
                        }
                        
                        values.push(roll);
                    } else {
                        // For non-required attributes use Method I (3d6)
                        values.push(this.rollThreeD6());
                    }
                }
                
                this.applyAttributeValues(values);
                this.methodVIClassSelection = false; // Hide class selection after attributes are generated
            },
            
            calculateClassFitnessScore(characterClass) {
                if (!this.attributes) return 0;
                
                // Base score starts at 0
                let fitnessScore = 0;
                let totalPossibleScore = 0;
                
                // Get number of requirements for this class
                const requirementsCount = Object.keys(characterClass.requirements).length;
                
                // Calculate score based on attribute bonus bands
                for (const [attrName, minValue] of Object.entries(characterClass.requirements)) {
                    const attrValue = this.getAttributeValue(attrName);
                    
                    if (attrValue >= minValue) {
                        // Calculate band-based score
                        // Bands: 9-12, 13-14, 15-16, 17, 18
                        let bandScore = 0;
                        
                        if (attrValue >= 18) {
                            bandScore = 1.0; // Maximum score for attribute 18
                        } else if (attrValue === 17) {
                            bandScore = 0.8; // Score for attribute 17
                        } else if (attrValue >= 15) {
                            bandScore = 0.6; // Score for attributes 15-16
                        } else if (attrValue >= 13) {
                            bandScore = 0.4; // Score for attributes 13-14
                        } else {
                            bandScore = 0.2; // Score for attributes 9-12
                        }
                        
                        fitnessScore += bandScore;
                    }
                    
                    // Add to total possible score
                    totalPossibleScore += 1;
                }
                
                // Check if all prime attributes are 16 or greater
                let allPrimeAttributesMeetThreshold = true;
                
                // Only check if there are prime attributes
                if (characterClass.primeAttributes.length > 0) {
                    for (const primeAttr of characterClass.primeAttributes) {
                        const attrName = primeAttr.charAt(0) + primeAttr.slice(1).toLowerCase();
                        const attrValue = this.getAttributeValue(attrName);
                        
                        if (attrValue < 16) {
                            allPrimeAttributesMeetThreshold = false;
                            break;
                        }
                    }
                    
                    // Add bonus only if all prime attributes are 16 or greater
                    // Use fixed bonus regardless of number of prime attributes
                    if (allPrimeAttributesMeetThreshold) {
                        // Add a significant fixed bonus when all prime attributes are 16+
                        fitnessScore += 1.0;
                        totalPossibleScore += 1.0;
                    }
                }
                
                // Apply a multiplier based on the number of requirements
                // This gives preference to classes that are harder to qualify for
                // The base multiplier starts at 1.0 for single-requirement classes
                const difficultyMultiplier = 1.0 + (requirementsCount - 1) * 0.15;
                
                // Apply the multiplier to the normalized score
                const normalizedScore = totalPossibleScore > 0 ? fitnessScore / totalPossibleScore : 0;
                
                // Return the adjusted score, capped at 1.0 to maintain the 0-1 range
                return Math.min(normalizedScore * difficultyMultiplier, 1.0);
            },
            
            getSortedQualifyingClasses() {
                if (!this.attributes) return [];
                
                // Filter and cache qualified classes with their fitness scores
                const qualifiedClasses = this.classes
                    .filter(c => this.qualifiesForClass(c))
                    .map(c => {
                        return {
                            ...c,
                            fitnessScore: this.calculateClassFitnessScore(c)
                        };
                    });
                
                // Sort by fitness score (descending)
                const sortedClasses = qualifiedClasses.sort((a, b) => b.fitnessScore - a.fitnessScore);
                
                // Assign ranks (same rank for same scores, no rank skipping)
                if (sortedClasses.length > 0) {
                    let currentRank = 1;
                    let currentScore = sortedClasses[0].fitnessScore;
                    let sameRankCount = 1;
                    
                    sortedClasses[0].rank = currentRank;
                    
                    for (let i = 1; i < sortedClasses.length; i++) {
                        if (Math.abs(sortedClasses[i].fitnessScore - currentScore) < 0.0001) {
                            // Same score, assign same rank
                            sortedClasses[i].rank = currentRank;
                            sameRankCount++;
                        } else {
                            // Different score, increment rank by 1 regardless of how many had the previous rank
                            currentRank++;
                            currentScore = sortedClasses[i].fitnessScore;
                            sortedClasses[i].rank = currentRank;
                            sameRankCount = 1;
                        }
                    }
                }
                
                return sortedClasses;
            }
        }));
    });
</script>
</body>
</html>